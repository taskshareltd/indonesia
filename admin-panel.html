<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - TaskShare</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Styling Khusus Admin Panel */
        body {
            background-color: #F8F8F8; 
            max-width: 1000px;
            padding-bottom: 20px;
        }
        .admin-header {
            background-color: #EF4444; 
            color: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #E5E7EB;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #64748B;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .tab-button.active {
            color: #EF4444;
            border-bottom: 3px solid #EF4444;
        }
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        .tab-content.active {
            display: block;
        }
        .action-button {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 5px;
            border: none;
        }
        .btn-approve { background-color: var(--color-primary); color: white; }
        .btn-reject { background-color: #FCA5A5; color: #DC2626; }
        .btn-blue { background-color: #3B82F6; color: white; }
        .btn-purple { background-color: #8B5CF6; color: white; }
        
        /* User Card Styles */
        .user-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-primary);
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            padding: 10px;
            background: #F8FAFC;
            border-radius: 8px;
        }
        .info-label {
            font-size: 0.8em;
            color: #64748B;
            margin-bottom: 5px;
        }
        .info-value {
            font-weight: 600;
            font-size: 1em;
        }
        
        /* Search Bar */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .search-button {
            padding: 12px 20px;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* Task Cards */
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #E2E8F0;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .caption-box {
            background: #F7FAFF;
            border: 1px dashed #3B82F6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        /* Withdraw Cards */
        .withdraw-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #3B82F6;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #E2E8F0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }
        .page-btn.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-cog"></i> Admin Panel TaskShare</h1>
                <p id="admin-welcome">Memuat data...</p>
            </div>
            <button id="admin-logout" class="btn-primary" style="background-color: white; color: #EF4444; width: auto; padding: 10px 15px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="dashboard-tab"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="tab-button" data-tab="tasks-tab"><i class="fas fa-list-check"></i> Verifikasi Tugas (<span id="pending-tasks-count">0</span>)</button>
            <button class="tab-button" data-tab="withdraws-tab"><i class="fas fa-dollar-sign"></i> Proses Withdraw (<span id="pending-withdraws-count">0</span>)</button>
            <button class="tab-button" data-tab="users-tab"><i class="fas fa-users"></i> Manajemen User (<span id="total-users-count">0</span>)</button>
            <button class="tab-button" data-tab="master-tasks-tab"><i class="fas fa-edit"></i> Kelola Tugas (<span id="total-tasks-count">0</span>)</button>
        </nav>

        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="card">
                <h3>Statistik Singkat</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <p class="info-label">Total User</p>
                        <p class="info-value" id="total-users">0</p>
                    </div>
                    <div>
                        <p class="info-label">Total Saldo User</p>
                        <p class="info-value" id="total-balance">Rp 0</p>
                    </div>
                    <div>
                        <p class="info-label">Total Tugas</p>
                        <p class="info-value" id="total-tasks">0</p>
                    </div>
                    <div>
                        <p class="info-label">Total Withdraw Pending</p>
                        <p class="info-value" id="total-withdraws-pending">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>Berikan Saldo Manual</h3>
                <form id="manual-balance-form">
                    <input type="email" id="target-email" placeholder="Email User Target" required style="margin-bottom: 15px;">
                    <input type="number" id="manual-amount" placeholder="Jumlah Saldo (+/-)" required style="margin-bottom: 15px;">
                    <textarea id="manual-desc" placeholder="Deskripsi/Alasan Bonus" required style="width: 100%; padding: 12px; border: 1px solid #E2E8F0; border-radius: 8px; margin-bottom: 15px;"></textarea>
                    <button type="submit" class="btn-primary">Kirim Saldo</button>
                    <p id="manual-balance-status" style="margin-top: 10px; color: red;"></p>
                </form>
            </div>
        </div>

        <!-- VERIFIKASI TUGAS TAB -->
        <div id="tasks-tab" class="tab-content">
            <h3>Tugas Menunggu Verifikasi</h3>
            <div class="search-container">
                <input type="text" id="task-search" placeholder="Cari berdasarkan username atau judul tugas" class="search-input">
                <select id="task-sort" class="search-input" style="width: auto;">
                    <option value="newest">Terbaru</option>
                    <option value="oldest">Terlama</option>
                </select>
                <button id="refresh-tasks" class="search-button">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="pending-tasks-list">
                <p>Memuat tugas...</p>
            </div>
        </div>

        <!-- PROSES WITHDRAW TAB -->
        <div id="withdraws-tab" class="tab-content">
            <h3>Permintaan Withdraw Pending</h3>
            <div class="search-container">
                <input type="text" id="withdraw-search" placeholder="Cari berdasarkan username atau metode" class="search-input">
                <select id="withdraw-sort" class="search-input" style="width: auto;">
                    <option value="newest">Terbaru</option>
                    <option value="oldest">Terlama</option>
                    <option value="amount-high">Jumlah Tertinggi</option>
                    <option value="amount-low">Jumlah Terendah</option>
                </select>
            </div>
            <div id="pending-withdraws-list">
                <p>Memuat permintaan withdraw...</p>
            </div>
        </div>

        <!-- MANAJEMEN USER TAB -->
        <div id="users-tab" class="tab-content">
            <h3>Daftar Pengguna Lengkap</h3>
            
            <div class="search-container">
                <input type="text" id="user-search" placeholder="Cari berdasarkan username, email, atau referral" class="search-input">
                <select id="user-sort" class="search-input" style="width: auto;">
                    <option value="newest">Terbaru</option>
                    <option value="oldest">Terlama</option>
                    <option value="balance-high">Saldo Tertinggi</option>
                    <option value="balance-low">Saldo Terendah</option>
                    <option value="username">Username A-Z</option>
                </select>
                <button id="refresh-users" class="search-button">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div style="text-align: right; margin-bottom: 10px;">
                <span id="user-pagination-info" style="color: #64748B;">Menampilkan 0 dari 0 user</span>
            </div>
            
            <div id="users-list" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                <p>Memuat daftar pengguna...</p>
            </div>
            
            <div class="pagination" id="user-pagination"></div>
        </div>

        <!-- KELOLA TUGAS TAB -->
        <!-- GANTI bagian Buat Tugas Baru dengan ini: -->
<div id="master-tasks-tab" class="tab-content">
    <h3><i class="fas fa-plus-circle"></i> Buat Tugas Baru</h3>
    
    <form id="create-task-form" class="card">
        <!-- JUDUL TUGAS -->
        <div style="margin-bottom: 15px;">
            <label for="task-title" style="display: block; margin-bottom: 5px; font-weight: 600;">
                <i class="fas fa-heading"></i> Judul Tugas
            </label>
            <input type="text" 
                   id="task-title" 
                   placeholder="Contoh: Share ke 5 Grup WA" 
                   required
                   style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
        </div>
        
        <!-- DESKRIPSI -->
        <div style="margin-bottom: 15px;">
            <label for="task-description" style="display: block; margin-bottom: 5px; font-weight: 600;">
                <i class="fas fa-align-left"></i> Deskripsi Tugas
            </label>
            <textarea id="task-description" 
                      placeholder="Jelaskan secara detail tugas yang harus dilakukan user..." 
                      required
                      style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; min-height: 100px;"></textarea>
        </div>
        
        <!-- REWARD -->
        <div style="margin-bottom: 15px;">
            <label for="task-reward" style="display: block; margin-bottom: 5px; font-weight: 600;">
                <i class="fas fa-money-bill-wave"></i> Reward (IDR)
            </label>
            <input type="number" 
                   id="task-reward" 
                   placeholder="1000" 
                   required 
                   min="100"
                   style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
        </div>
        
        <!-- LINK AMBIL GAMBAR -->
        <div style="margin-bottom: 20px;">
            <label for="task-image-link" style="display: block; margin-bottom: 5px; font-weight: 600;">
                <i class="fas fa-link"></i> Link Ambil Gambar
            </label>
            <input type="url" 
                   id="task-image-link" 
                   placeholder="https://wa.me/6281234567890 atau https://t.me/username" 
                   required
                   style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
            
            <div style="background: #F0F9FF; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #3B82F6;">
                <p style="margin: 0 0 10px 0; font-weight: 600; color: #1E40AF;">
                    <i class="fas fa-info-circle"></i> Cara Mengisi Link:
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <p style="margin: 0 0 5px 0; font-weight: 600; color: #25D366;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </p>
                        <p style="margin: 0; font-size: 0.9em; color: #64748B;">
                            Format: <code>https://wa.me/6281234567890</code><br>
                            User akan klik tombol "Ambil Gambar Disini"
                        </p>
                    </div>      
                </div>
            </div>
        </div>
        
        <!-- CAPTION UNTUK DISALIN -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                <i class="fas fa-quote-right"></i> Caption yang Harus Disalin User
            </label>
            
            <div class="caption-box">
                <textarea id="task-caption" 
                          placeholder="Masukkan caption yang harus disalin user untuk diposting..." 
                          required
                          style="width: 100%; border: none; background: transparent; min-height: 120px; resize: vertical;"></textarea>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <button type="button" 
                            onclick="copyTaskCaption()" 
                            style="padding: 8px 15px; background: #3B82F6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-copy"></i> Salin Caption
                    </button>
                    
                    <div style="font-size: 0.8em; color: #64748B;">
                        <span id="caption-counter">0</span> / 500 karakter
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BUTTON SUBMIT -->
        <button type="submit" class="btn-primary" style="padding: 14px 20px; font-size: 1.1rem; width: 100%;">
            <i class="fas fa-save"></i> Simpan Tugas Baru
        </button>
        
        <p id="create-task-status" style="margin-top: 10px; text-align: center;"></p>
    </form>

    <h3 style="margin-top: 30px;">
        <i class="fas fa-list-check"></i> Daftar Tugas Aktif
        <span style="font-size: 0.8em; color: #64748B; margin-left: 10px;" id="active-tasks-count">(0 tugas)</span>
    </h3>
    
    <div class="search-container">
        <input type="text" id="master-task-search" placeholder="Cari berdasarkan judul tugas" class="search-input">
        <button id="refresh-master-tasks" class="search-button">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    
    <div id="active-tasks-list">
        <p>Memuat tugas aktif...</p>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        const ADMIN_SESSION_KEY = "taskshare_admin_logged_in";
        
        // Elements
        const totalUsers = document.getElementById('total-users');
        const totalBalance = document.getElementById('total-balance');
        const totalUsersCount = document.getElementById('total-users-count');
        const totalTasksCount = document.getElementById('total-tasks-count');
        const totalTasks = document.getElementById('total-tasks');
        const totalWithdrawsPending = document.getElementById('total-withdraws-pending');
        const pendingTasksCount = document.getElementById('pending-tasks-count');
        const pendingWithdrawsCount = document.getElementById('pending-withdraws-count');
        const pendingTasksList = document.getElementById('pending-tasks-list');
        const pendingWithdrawsList = document.getElementById('pending-withdraws-list');
        const usersList = document.getElementById('users-list');
        const manualBalanceForm = document.getElementById('manual-balance-form');
        const manualBalanceStatus = document.getElementById('manual-balance-status');
        const createTaskForm = document.getElementById('create-task-form');
        const createTaskStatus = document.getElementById('create-task-status');
        const activeTasksList = document.getElementById('active-tasks-list');
        const adminWelcome = document.getElementById('admin-welcome');
        const userPagination = document.getElementById('user-pagination');
        const userPaginationInfo = document.getElementById('user-pagination-info');
        
        // Data caching
        let allTasks = {};
        let allUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        let totalPages = 1;

        // --- AUTH GUARD ---
        if (sessionStorage.getItem(ADMIN_SESSION_KEY) !== 'true') {
            window.location.href = 'admin.html';
        }
        
        // Set welcome message
        adminWelcome.textContent = `Selamat datang, Admin! ${new Date().toLocaleDateString('id-ID')}`;
        
        document.getElementById('admin-logout').addEventListener('click', () => {
            sessionStorage.removeItem(ADMIN_SESSION_KEY);
            window.location.href = 'admin.html';
        });

        // --- TAB SWITCHING ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(tabId).classList.add('active');

                // Load data saat tab aktif
                if (tabId === 'users-tab') {
                    loadAllUsers();
                    setupUserSearch();
                }
                if (tabId === 'master-tasks-tab') {
                    loadMasterTasks();
                    setupTaskSearch();
                }
                if (tabId === 'tasks-tab') {
                    loadPendingTasks();
                    setupPendingTaskSearch();
                }
                if (tabId === 'withdraws-tab') {
                    loadPendingWithdraws();
                    setupWithdrawSearch();
                }
            });
        });

        // --- HELPER FUNCTIONS ---
        const formatIDR = (num) => new Intl.NumberFormat('id-ID', { 
            style: 'currency', 
            currency: 'IDR', 
            minimumFractionDigits: 0 
        }).format(num || 0);

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // --- COPY FUNCTION ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Teks berhasil disalin!');
            }).catch(err => {
                console.error('Gagal menyalin:', err);
            });
        }

        function copyTaskCaption() {
            const captionText = document.getElementById('task-caption').value;
            if (captionText.trim()) {
                copyToClipboard(captionText);
            }
        }

        // ===================================
        // 1. DASHBOARD & MANUAL BALANCE
        // ===================================
        
        async function loadDashboardStats() {
            try {
                // Load semua data sekaligus
                const [usersSnapshot, tasksSnapshot, withdrawsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('tasks').get(),
                    db.collection('withdraws').where('status', '==', 'pending').get()
                ]);
                
                let totalB = 0;
                usersSnapshot.forEach(doc => {
                    totalB += doc.data().balance || 0;
                });

                totalUsers.textContent = usersSnapshot.size.toLocaleString('id-ID');
                totalUsersCount.textContent = usersSnapshot.size;
                totalBalance.textContent = formatIDR(totalB);
                totalTasks.textContent = tasksSnapshot.size;
                totalTasksCount.textContent = tasksSnapshot.size;
                totalWithdrawsPending.textContent = withdrawsSnapshot.size;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        manualBalanceForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const targetEmail = document.getElementById('target-email').value;
            const amount = parseInt(document.getElementById('manual-amount').value);
            const desc = document.getElementById('manual-desc').value;
            manualBalanceStatus.textContent = '';

            try {
                // Cari UID berdasarkan Email
                const userSnapshot = await db.collection('users').where('email', '==', targetEmail).limit(1).get();
                
                if (userSnapshot.empty) {
                    manualBalanceStatus.textContent = 'Error: User dengan email tersebut tidak ditemukan.';
                    return;
                }

                const uid = userSnapshot.docs[0].id;
                const userData = userSnapshot.docs[0].data();
                
                // Update Saldo
                await db.collection("users").doc(uid).update({
                    balance: firebase.firestore.FieldValue.increment(amount)
                });

                // Buat Riwayat
                await db.collection("history").add({
                    uid: uid,
                    type: "bonus",
                    amount: amount,
                    description: desc + " (Dari Admin)",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                manualBalanceStatus.style.color = 'var(--color-primary)';
                manualBalanceStatus.textContent = `Berhasil memberikan ${formatIDR(amount)} ke ${userData.username} (${targetEmail}).`;
                manualBalanceForm.reset();
                loadDashboardStats();

            } catch (error) {
                manualBalanceStatus.style.color = 'red';
                manualBalanceStatus.textContent = `Gagal: ${error.message}`;
            }
        });

        // ===================================
        // 2. VERIFIKASI TUGAS
        // ===================================
        
        let pendingTasksData = [];
        
        async function loadPendingTasks() {
            try {
                const snapshot = await db.collection("user_tasks")
                    .where("status", "==", "pending")
                    .orderBy("submittedAt", "desc")
                    .get();
                
                pendingTasksData = [];
                const userPromises = [];
                
                snapshot.forEach(doc => {
                    const submission = doc.data();
                    submission.id = doc.id;
                    pendingTasksData.push(submission);
                    
                    // Load user data for each submission
                    userPromises.push(
                        db.collection('users').doc(submission.uid).get()
                            .then(userDoc => {
                                if (userDoc.exists) {
                                    submission.userData = userDoc.data();
                                }
                                return submission;
                            })
                    );
                });
                
                await Promise.all(userPromises);
                pendingTasksCount.textContent = pendingTasksData.length;
                displayPendingTasks(pendingTasksData);
                
            } catch (error) {
                console.error("Error loading pending tasks:", error);
                pendingTasksList.innerHTML = '<p style="color: red;">Gagal memuat tugas. Cek konsol untuk detail.</p>';
            }
        }
        
        function displayPendingTasks(tasks) {
            pendingTasksList.innerHTML = '';
            
            if (tasks.length === 0) {
                pendingTasksList.innerHTML = '<p>Tidak ada tugas yang menunggu verifikasi.</p>';
                return;
            }
            
            tasks.forEach(submission => {
                const task = allTasks[submission.taskId];
                const taskTitle = task ? task.title : 'Tugas Dihapus';
                const taskReward = task ? formatIDR(task.reward) : 'Rp 0';
                const userData = submission.userData || { username: 'Unknown', email: 'N/A' };
                
                pendingTasksList.innerHTML += `
                    <div class="task-card">
                        <div class="task-header">
                            <h4>${taskTitle} (${taskReward})</h4>
                            <span style="color: orange; font-weight: 600;">PENDING</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <p class="info-label">User</p>
                                <p class="info-value">${userData.username} (${userData.email})</p>
                            </div>
                            <div>
                                <p class="info-label">Dikirim</p>
                                <p class="info-value">${formatDate(submission.submittedAt)}</p>
                            </div>
                        </div>
                        
                        <p class="info-label">Screenshot Bukti:</p>
                        <img src="${submission.screenshot}" alt="Bukti Tugas" 
                             style="max-width: 100%; max-height: 300px; border-radius: 8px; margin: 10px 0; cursor: pointer;" 
                             onclick="window.open('${submission.screenshot}', '_blank')">
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="action-button btn-approve" onclick="verifyTask('${submission.id}', '${submission.uid}', '${submission.taskId}', 'approved')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="action-button btn-reject" onclick="verifyTask('${submission.id}', '${submission.uid}', '${submission.taskId}', 'rejected')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="action-button btn-blue" onclick="viewUserDetails('${submission.uid}')">
                                <i class="fas fa-user"></i> Lihat User
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        function setupPendingTaskSearch() {
            const searchInput = document.getElementById('task-search');
            const sortSelect = document.getElementById('task-sort');
            const refreshBtn = document.getElementById('refresh-tasks');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = pendingTasksData.filter(submission => {
                    const userData = submission.userData || {};
                    const task = allTasks[submission.taskId] || {};
                    return (
                        userData.username?.toLowerCase().includes(searchTerm) ||
                        userData.email?.toLowerCase().includes(searchTerm) ||
                        task.title?.toLowerCase().includes(searchTerm)
                    );
                });
                displayPendingTasks(filtered);
            });
            
            sortSelect.addEventListener('change', () => {
                const sorted = [...pendingTasksData].sort((a, b) => {
                    if (sortSelect.value === 'newest') {
                        return b.submittedAt - a.submittedAt;
                    } else {
                        return a.submittedAt - b.submittedAt;
                    }
                });
                displayPendingTasks(sorted);
            });
            
            refreshBtn.addEventListener('click', loadPendingTasks);
        }
        
        async function verifyTask(submissionId, uid, taskId, status) {
            const task = allTasks[taskId];
            if (!task) {
                alert("Data tugas tidak ditemukan!");
                return;
            }

            if (!confirm(`Apakah Anda yakin ingin ${status === 'approved' ? 'menyetujui' : 'menolak'} tugas ini?`)) {
                return;
            }

            try {
                // 1. Update status submission
                await db.collection("user_tasks").doc(submissionId).update({
                    status: status,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (status === 'approved') {
                    // 2. Tambahkan Saldo
                    await db.collection("users").doc(uid).update({
                        balance: firebase.firestore.FieldValue.increment(task.reward)
                    });

                    // 3. Buat Riwayat
                    await db.collection("history").add({
                        uid: uid,
                        type: "task",
                        amount: task.reward,
                        description: `Reward Tugas disetujui: ${task.title}`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert(`Tugas disetujui! Saldo ${formatIDR(task.reward)} ditambahkan ke user.`);
                } else {
                    alert("Tugas ditolak. Tidak ada perubahan saldo.");
                }

                // Refresh list
                loadPendingTasks();
                
            } catch (error) {
                console.error("Verification Error:", error);
                alert(`Gagal memverifikasi tugas: ${error.message}`);
            }
        }

        // ===================================
        // 3. PROSES WITHDRAW (FIXED VERSION)
        // ===================================
        
        let pendingWithdrawsData = [];
        
        async function loadPendingWithdraws() {
            try {
                const snapshot = await db.collection("withdraws")
                    .where("status", "==", "pending")
                    .orderBy("requestedAt", "desc")
                    .get();
                
                pendingWithdrawsData = [];
                const userPromises = [];
                
                snapshot.forEach(doc => {
                    const wd = doc.data();
                    wd.id = doc.id;
                    pendingWithdrawsData.push(wd);
                    
                    userPromises.push(
                        db.collection('users').doc(wd.uid).get()
                            .then(userDoc => {
                                if (userDoc.exists) {
                                    wd.userData = userDoc.data();
                                }
                                return wd;
                            })
                    );
                });
                
                await Promise.all(userPromises);
                pendingWithdrawsCount.textContent = pendingWithdrawsData.length;
                displayPendingWithdraws(pendingWithdrawsData);
                
            } catch (error) {
                console.error("Error loading pending withdraws:", error);
                pendingWithdrawsList.innerHTML = '<p style="color: red;">Gagal memuat permintaan withdraw.</p>';
            }
        }
        
        function displayPendingWithdraws(withdraws) {
            pendingWithdrawsList.innerHTML = '';
            
            if (withdraws.length === 0) {
                pendingWithdrawsList.innerHTML = '<p>Tidak ada permintaan withdraw pending.</p>';
                return;
            }
            
            withdraws.forEach(wd => {
                const userData = wd.userData || { username: 'Unknown', email: 'N/A' };
                const amountFormatted = formatIDR(wd.amount);
                
                // FIX: Handle both old and new data formats
                const accountName = wd.accountName || 'N/A';
                const accountNumber = wd.accountNumber || wd.number || 'N/A';
                const userBalance = wd.userBalance || 0;
                
                pendingWithdrawsList.innerHTML += `
                    <div class="withdraw-card">
                        <div class="task-header">
                            <h4>Withdraw ${amountFormatted}</h4>
                            <span style="color: orange; font-weight: 600;">PENDING</span>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <p><strong>User:</strong> ${userData.username} (${userData.email})</p>
                            <p><strong>Metode:</strong> ${wd.method}</p>
                            <p><strong>Nama:</strong> ${accountName}</p>
                            <p><strong>Nomor:</strong> ${accountNumber}</p>
                            <p><strong>Saldo Sebelum:</strong> ${formatIDR(userBalance)}</p>
                            <p><strong>Saldo Setelah:</strong> ${formatIDR(userBalance - wd.amount)}</p>
                        </div>
                        
                        <p style="font-size: 0.8em; color: #64748B;">
                            <i class="fas fa-clock"></i> Diajukan: ${formatDate(wd.requestedAt)}
                        </p>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="action-button btn-approve" 
                                    onclick="processWithdraw('${wd.id}', 'done', ${wd.amount}, '${wd.uid}')"
                                    style="background-color: #3B82F6; color: white;">
                                <i class="fas fa-check-circle"></i> Tandai Selesai
                            </button>
                            <button class="action-button btn-reject" 
                                    onclick="processWithdraw('${wd.id}', 'rejected', ${wd.amount}, '${wd.uid}')">
                                <i class="fas fa-times-circle"></i> Tolak & Refund
                            </button>
                            <button class="action-button btn-blue" 
                                    onclick="viewUserDetails('${wd.uid}')">
                                <i class="fas fa-user"></i> Lihat User
                            </button>
                            <button class="action-button" 
                                    onclick="copyWithdrawData('${accountName}', '${accountNumber}', ${wd.amount})"
                                    style="background-color: #8B5CF6; color: white;">
                                <i class="fas fa-copy"></i> Salin Data
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        // Helper untuk copy data withdraw
        function copyWithdrawData(name, number, amount) {
            const text = `Nama: ${name}\nNomor: ${number}\nJumlah: ${formatIDR(amount)}`;
            navigator.clipboard.writeText(text).then(() => {
                alert('Data berhasil disalin ke clipboard!');
            }).catch(err => {
                console.error('Gagal menyalin:', err);
            });
        }
        
        function setupWithdrawSearch() {
            const searchInput = document.getElementById('withdraw-search');
            const sortSelect = document.getElementById('withdraw-sort');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = pendingWithdrawsData.filter(wd => {
                    const userData = wd.userData || {};
                    const accountName = wd.accountName || '';
                    const accountNumber = wd.accountNumber || wd.number || '';
                    return (
                        userData.username?.toLowerCase().includes(searchTerm) ||
                        userData.email?.toLowerCase().includes(searchTerm) ||
                        wd.method?.toLowerCase().includes(searchTerm) ||
                        accountName.toLowerCase().includes(searchTerm) ||
                        accountNumber.toLowerCase().includes(searchTerm)
                    );
                });
                
                // Sort filtered results
                const sorted = sortWithdraws(filtered, sortSelect.value);
                displayPendingWithdraws(sorted);
            });
            
            sortSelect.addEventListener('change', () => {
                const sorted = sortWithdraws(pendingWithdrawsData, sortSelect.value);
                displayPendingWithdraws(sorted);
            });
        }
        
        function sortWithdraws(withdraws, sortBy) {
            return [...withdraws].sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return b.requestedAt - a.requestedAt;
                    case 'oldest':
                        return a.requestedAt - b.requestedAt;
                    case 'amount-high':
                        return b.amount - a.amount;
                    case 'amount-low':
                        return a.amount - b.amount;
                    default:
                        return 0;
                }
            });
        }
        
        async function processWithdraw(wdId, status, amount, uid) {
            const action = status === 'done' ? 'menyelesaikan' : 'menolak';
            
            if (!confirm(`Apakah Anda yakin ingin ${action} withdraw ini?`)) {
                return;
            }

            try {
                // 1. Update status withdraw
                await db.collection("withdraws").doc(wdId).update({
                    status: status,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (status === 'rejected') {
                    // 2. REFUND SALDO
                    await db.collection("users").doc(uid).update({
                        balance: firebase.firestore.FieldValue.increment(amount)
                    });

                    // 3. Buat Riwayat Refund
                    await db.collection("history").add({
                        uid: uid,
                        type: "withdraw_refund",
                        amount: amount,
                        description: `Withdraw ditolak, saldo ${formatIDR(amount)} dikembalikan.`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert("Withdraw ditolak, saldo berhasil dikembalikan ke user.");
                } else {
                    alert("Withdraw ditandai selesai.");
                }

                // Refresh list
                loadPendingWithdraws();
                
            } catch (error) {
                console.error("Withdrawal Process Error:", error);
                alert(`Gagal memproses withdraw: ${error.message}`);
            }
        }

        // ===================================
        // 4. MANAJEMEN USER LENGKAP
        // ===================================
        
        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allUsers = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    user.id = doc.id;
                    allUsers.push(user);
                });
                
                displayUsersPage(1);
                setupPagination();
                
            } catch (error) {
                console.error("Error loading users:", error);
                usersList.innerHTML = '<p style="color: red;">Gagal memuat data user.</p>';
            }
        }
        
        function displayUsersPage(page) {
            currentPage = page;
            const searchTerm = document.getElementById('user-search')?.value.toLowerCase() || '';
            const sortBy = document.getElementById('user-sort')?.value || 'newest';
            
            // Filter users
            let filteredUsers = allUsers.filter(user => {
                return (
                    user.username?.toLowerCase().includes(searchTerm) ||
                    user.email?.toLowerCase().includes(searchTerm) ||
                    user.referral?.toLowerCase().includes(searchTerm)
                );
            });
            
            // Sort users
            filteredUsers = sortUsers(filteredUsers, sortBy);
            
            // Pagination
            totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const startIndex = (page - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);
            
            // Display
            usersList.innerHTML = '';
            
            if (usersToShow.length === 0) {
                usersList.innerHTML = '<p>Tidak ada user yang ditemukan.</p>';
                userPaginationInfo.textContent = 'Menampilkan 0 dari 0 user';
                return;
            }
            
            usersToShow.forEach(async (user) => {
                // Count referrals
                const referralsSnapshot = await db.collection('users')
                    .where('referredBy', '==', user.id)
                    .get();
                
                // Count completed tasks
                const tasksSnapshot = await db.collection('user_tasks')
                    .where('uid', '==', user.id)
                    .where('status', '==', 'approved')
                    .get();
                
                // Count total withdrawals
                const withdrawsSnapshot = await db.collection('withdraws')
                    .where('uid', '==', user.id)
                    .get();
                
                usersList.innerHTML += `
                    <div class="user-card">
                        <div class="user-header">
                            <div>
                                <h4>${user.username}</h4>
                                <p style="color: #64748B; font-size: 0.9em;">${user.email}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="color: var(--color-primary); font-weight: 700; font-size: 1.2em;">
                                    ${formatIDR(user.balance || 0)}
                                </p>
                                <p style="font-size: 0.8em; color: #64748B;">ID: ${user.id.substring(0, 8)}...</p>
                            </div>
                        </div>
                        
                        <div class="user-info-grid">
                            <div class="info-item">
                                <p class="info-label">Kode Referral</p>
                                <p class="info-value">${user.referral || 'N/A'}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label">Jumlah Referral</p>
                                <p class="info-value">${referralsSnapshot.size} orang</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label">Tugas Selesai</p>
                                <p class="info-value">${tasksSnapshot.size} tugas</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label">Total Withdraw</p>
                                <p class="info-value">${withdrawsSnapshot.size} kali</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label">Tanggal Daftar</p>
                                <p class="info-value">${formatDate(user.createdAt)}</p>
                            </div>
                            <div class="info-item">
                                <p class="info-label">Terakhir Login</p>
                                <p class="info-value">${user.lastLogin ? formatDate(user.lastLogin) : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="action-button btn-blue" onclick="viewUserFullDetails('${user.id}')">
                                <i class="fas fa-eye"></i> Detail Lengkap
                            </button>
                            <button class="action-button btn-purple" onclick="addBalanceToUser('${user.id}', '${user.username}')">
                                <i class="fas fa-plus-circle"></i> Tambah Saldo
                            </button>
                            <button class="action-button" style="background-color: #10B981; color: white;" 
                                    onclick="sendMessageToUser('${user.id}', '${user.email}')">
                                <i class="fas fa-envelope"></i> Kirim Pesan
                            </button>
                            <button class="action-button btn-reject" onclick="deleteUser('${user.id}', '${user.email}')">
                                <i class="fas fa-trash"></i> Hapus User
                            </button>
                        </div>
                    </div>
                `;
            });
            
            userPaginationInfo.textContent = `Menampilkan ${startIndex + 1}-${Math.min(endIndex, filteredUsers.length)} dari ${filteredUsers.length} user`;
        }
        
        function sortUsers(users, sortBy) {
            return [...users].sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    case 'oldest':
                        return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    case 'balance-high':
                        return (b.balance || 0) - (a.balance || 0);
                    case 'balance-low':
                        return (a.balance || 0) - (b.balance || 0);
                    case 'username':
                        return (a.username || '').localeCompare(b.username || '');
                    default:
                        return 0;
                }
            });
        }
        
        function setupPagination() {
            userPagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.onclick = () => displayUsersPage(currentPage - 1);
                userPagination.appendChild(prevBtn);
            }
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => displayUsersPage(i);
                userPagination.appendChild(pageBtn);
            }
            
            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = () => displayUsersPage(currentPage + 1);
                userPagination.appendChild(nextBtn);
            }
        }
        
        function setupUserSearch() {
            const searchInput = document.getElementById('user-search');
            const sortSelect = document.getElementById('user-sort');
            const refreshBtn = document.getElementById('refresh-users');
            
            searchInput?.addEventListener('input', () => {
                displayUsersPage(1);
                setupPagination();
            });
            
            sortSelect?.addEventListener('change', () => {
                displayUsersPage(1);
                setupPagination();
            });
            
            refreshBtn?.addEventListener('click', () => {
                loadAllUsers();
            });
        }
        
        async function viewUserFullDetails(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User tidak ditemukan!');
                    return;
                }
                
                const user = userDoc.data();
                
                // Get additional data
                const [referrals, tasks, withdraws, history] = await Promise.all([
                    db.collection('users').where('referredBy', '==', userId).get(),
                    db.collection('user_tasks').where('uid', '==', userId).get(),
                    db.collection('withdraws').where('uid', '==', userId).get(),
                    db.collection('history').where('uid', '==', userId).orderBy('createdAt', 'desc').limit(10).get()
                ]);
                
                let detailsHTML = `
                    <h3>Detail Lengkap User: ${user.username}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div><strong>Email:</strong> ${user.email}</div>
                        <div><strong>Saldo:</strong> ${formatIDR(user.balance)}</div>
                        <div><strong>Kode Referral:</strong> ${user.referral}</div>
                        <div><strong>Tanggal Daftar:</strong> ${formatDate(user.createdAt)}</div>
                        <div><strong>Total Referral:</strong> ${referrals.size} orang</div>
                        <div><strong>Total Tugas:</strong> ${tasks.size} tugas</div>
                        <div><strong>Total Withdraw:</strong> ${withdraws.size} kali</div>
                    </div>
                    
                    <h4>10 Transaksi Terakhir:</h4>
                `;
                
                if (history.empty) {
                    detailsHTML += '<p>Belum ada transaksi.</p>';
                } else {
                    detailsHTML += '<ul style="list-style: none; padding: 0;">';
                    history.forEach(doc => {
                        const trans = doc.data();
                        detailsHTML += `
                            <li style="padding: 10px; border-bottom: 1px solid #E2E8F0;">
                                <strong>${trans.description}</strong><br>
                                <span style="color: ${trans.amount > 0 ? 'green' : 'red'}">
                                    ${trans.amount > 0 ? '+' : ''}${formatIDR(trans.amount)}
                                </span>
                                <span style="color: #64748B; font-size: 0.8em;">
                                    - ${formatDate(trans.createdAt)}
                                </span>
                            </li>
                        `;
                    });
                    detailsHTML += '</ul>';
                }
                
                // Show in modal
                const modal = window.open('', 'UserDetails', 'width=800,height=600');
                modal.document.write(`
                    <html>
                    <head>
                        <title>Detail User: ${user.username}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            button { padding: 10px 15px; background: #EF4444; color: white; border: none; border-radius: 5px; cursor: pointer; }
                        </style>
                    </head>
                    <body>
                        ${detailsHTML}
                        <br><br>
                        <button onclick="window.print()">Print</button>
                        <button onclick="window.close()">Tutup</button>
                    </body>
                    </html>
                `);
                
            } catch (error) {
                console.error("Error viewing user details:", error);
                alert('Gagal memuat detail user.');
            }
        }
        
        function addBalanceToUser(userId, username) {
            const amount = prompt(`Masukkan jumlah saldo untuk ${username} (gunakan - untuk mengurangi):`, "1000");
            if (amount === null) return;
            
            const numAmount = parseInt(amount);
            if (isNaN(numAmount)) {
                alert('Jumlah tidak valid!');
                return;
            }
            
            const reason = prompt('Alasan penambahan/pengurangan saldo:', "Penyesuaian saldo admin");
            if (reason === null) return;
            
            if (confirm(`Apakah Anda yakin ingin ${numAmount >= 0 ? 'menambah' : 'mengurangi'} saldo ${formatIDR(Math.abs(numAmount))} untuk ${username}?`)) {
                db.collection("users").doc(userId).update({
                    balance: firebase.firestore.FieldValue.increment(numAmount)
                }).then(() => {
                    db.collection("history").add({
                        uid: userId,
                        type: "admin_adjustment",
                        amount: numAmount,
                        description: `Penyesuaian saldo oleh Admin: ${reason}`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert(`Saldo berhasil ${numAmount >= 0 ? 'ditambahkan' : 'dikurangkan'}!`);
                    loadAllUsers();
                }).catch(error => {
                    alert(`Gagal: ${error.message}`);
                });
            }
        }
        
        function sendMessageToUser(userId, email) {
            const message = prompt(`Kirim pesan ke ${email}:`, "");
            if (message && message.trim()) {
                alert(`Pesan akan dikirim ke ${email}:\n\n"${message}"`);
            }
        }
        
        async function deleteUser(userId, email) {
            if (!confirm(`Yakin ingin menghapus user ${email}?\n\nPERHATIAN: Ini hanya menghapus data dari Firestore. Akun auth harus dihapus manual dari Firebase Console.`)) {
                return;
            }
            
            try {
                await db.collection('users').doc(userId).delete();
                alert(`Data user ${email} berhasil dihapus dari Firestore.`);
                loadAllUsers();
                loadDashboardStats();
                
            } catch (error) {
                alert(`Gagal menghapus user: ${error.message}`);
            }
        }
        
        function viewUserDetails(userId) {
            document.querySelector('[data-tab="users-tab"]').click();
            setTimeout(() => {
                document.getElementById('user-search').value = userId;
                displayUsersPage(1);
                setupPagination();
            }, 100);
        }

        // ===================================
        // 5. KELOLA MASTER DATA TUGAS
        // ===================================
        
        async function loadMasterTasks() {
            try {
                const snapshot = await db.collection('tasks').orderBy('title').get();
                allTasks = {};
                activeTasksList.innerHTML = '';
                
                if (snapshot.empty) {
                    activeTasksList.innerHTML = '<p>Tidak ada tugas aktif.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskId = doc.id;
                    allTasks[taskId] = task;
                    
                    activeTasksList.innerHTML += `
                        <div class="task-card">
                            <div class="task-header">
                                <h4>${task.title}</h4>
                                <span style="color: var(--color-accent); font-weight: 600;">
                                    ${formatIDR(task.reward)}
                                </span>
                            </div>
                            
                            <p style="margin: 10px 0; color: #64748B;">${task.description}</p>
                            
                            ${task.image ? `<img src="${task.image}" alt="Petunjuk Tugas" style="max-width: 300px; max-height: 200px; border-radius: 8px; margin: 10px 0;">` : ''}
                            
                            <div class="caption-box">
                                <p style="font-weight: 600; margin-bottom: 10px;">Caption untuk disalin user:</p>
                                <div style="background: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em; max-height: 150px; overflow-y: auto;">
                                    ${task.caption || 'Tidak ada caption'}
                                </div>
                                <button onclick="copyToClipboard('${task.caption?.replace(/'/g, "\\'") || ''}')" class="copy-btn" style="top: 35px;">
                                    <i class="fas fa-copy"></i> Salin Caption
                                </button>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="action-button btn-blue" onclick="editTask('${taskId}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-button btn-reject" onclick="deleteTask('${taskId}', '${task.title.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                                <button class="action-button" style="background-color: #8B5CF6; color: white;" 
                                        onclick="viewTaskSubmissions('${taskId}', '${task.title}')">
                                    <i class="fas fa-list"></i> Lihat Submissions
                                </button>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Error loading master tasks:", error);
                activeTasksList.innerHTML = '<p style="color: red;">Gagal memuat daftar tugas.</p>';
            }
        }
        
        function setupTaskSearch() {
            const searchInput = document.getElementById('master-task-search');
            const refreshBtn = document.getElementById('refresh-master-tasks');
            
            searchInput?.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const taskCards = document.querySelectorAll('.task-card');
                
                taskCards.forEach(card => {
                    const title = card.querySelector('h4').textContent.toLowerCase();
                    const description = card.querySelector('p').textContent.toLowerCase();
                    const isVisible = title.includes(searchTerm) || description.includes(searchTerm);
                    card.style.display = isVisible ? 'block' : 'none';
                });
            });
            
            refreshBtn?.addEventListener('click', loadMasterTasks);
        }
        
        createTaskForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const reward = parseInt(document.getElementById('task-reward').value);
            const image = document.getElementById('task-image-url').value;
            const caption = document.getElementById('task-caption').value;
            createTaskStatus.textContent = '';
            
            if (reward < 100) {
                createTaskStatus.textContent = 'Reward minimal Rp 100';
                return;
            }
            
            if (!caption.trim()) {
                createTaskStatus.textContent = 'Caption wajib diisi untuk disalin user';
                return;
            }

            try {
                await db.collection("tasks").add({
                    title,
                    description,
                    reward,
                    image: image || '',
                    caption,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                createTaskStatus.style.color = 'var(--color-primary)';
                createTaskStatus.textContent = 'Tugas baru berhasil ditambahkan!';
                createTaskForm.reset();
                loadMasterTasks();
                loadDashboardStats();
                
            } catch (error) {
                createTaskStatus.style.color = 'red';
                createTaskStatus.textContent = `Gagal membuat tugas: ${error.message}`;
            }
        });
        
        function editTask(taskId) {
            const task = allTasks[taskId];
            if (!task) return;
            
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description;
            document.getElementById('task-reward').value = task.reward;
            document.getElementById('task-image-url').value = task.image || '';
            document.getElementById('task-caption').value = task.caption || '';
            
            // Change form to update mode
            const submitBtn = createTaskForm.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Tugas';
            submitBtn.onclick = async (e) => {
                e.preventDefault();
                
                const updatedData = {
                    title: document.getElementById('task-title').value,
                    description: document.getElementById('task-description').value,
                    reward: parseInt(document.getElementById('task-reward').value),
                    image: document.getElementById('task-image-url').value,
                    caption: document.getElementById('task-caption').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await db.collection('tasks').doc(taskId).update(updatedData);
                    alert('Tugas berhasil diupdate!');
                    createTaskForm.reset();
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Tugas Baru';
                    loadMasterTasks();
                } catch (error) {
                    alert(`Gagal update: ${error.message}`);
                }
            };
            
            document.getElementById('create-task-form').scrollIntoView();
        }
        
        async function deleteTask(taskId, title) {
            if (!confirm(`Yakin menghapus tugas "${title}"?\n\nTugas yang sudah di-submit user akan tetap ada, tapi reward-nya tidak terdefinisi.`)) {
                return;
            }
            try {
                await db.collection('tasks').doc(taskId).delete();
                alert(`Tugas "${title}" berhasil dihapus.`);
                loadMasterTasks();
                loadDashboardStats();
            } catch (error) {
                alert(`Gagal menghapus tugas: ${error.message}`);
            }
        }
        
        async function viewTaskSubmissions(taskId, taskTitle) {
            try {
                const snapshot = await db.collection('user_tasks')
                    .where('taskId', '==', taskId)
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    alert(`Belum ada user yang submit tugas "${taskTitle}"`);
                    return;
                }
                
                let submissionsHTML = `<h3>Submissions untuk: ${taskTitle}</h3>`;
                submissionsHTML += `<p>Total: ${snapshot.size} submission</p>`;
                
                const userPromises = [];
                snapshot.forEach(doc => {
                    const submission = doc.data();
                    submission.id = doc.id;
                    
                    userPromises.push(
                        db.collection('users').doc(submission.uid).get()
                            .then(userDoc => {
                                if (userDoc.exists) {
                                    submission.userData = userDoc.data();
                                }
                                return submission;
                            })
                    );
                });
                
                const submissions = await Promise.all(userPromises);
                
                submissionsHTML += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                submissionsHTML += `
                    <tr style="background: #F3F4F6;">
                        <th style="padding: 10px; text-align: left;">User</th>
                        <th style="padding: 10px; text-align: left;">Status</th>
                        <th style="padding: 10px; text-align: left;">Tanggal</th>
                        <th style="padding: 10px; text-align: left;">Aksi</th>
                    </tr>
                `;
                
                submissions.forEach(sub => {
                    const userData = sub.userData || {};
                    submissionsHTML += `
                        <tr style="border-bottom: 1px solid #E5E7EB;">
                            <td style="padding: 10px;">${userData.username || 'Unknown'}<br>
                                <small style="color: #6B7280;">${userData.email || 'N/A'}</small>
                            </td>
                            <td style="padding: 10px;">
                                <span style="color: ${sub.status === 'approved' ? 'green' : sub.status === 'rejected' ? 'red' : 'orange'};">
                                    ${sub.status.toUpperCase()}
                                </span>
                            </td>
                            <td style="padding: 10px;">${formatDate(sub.submittedAt)}</td>
                            <td style="padding: 10px;">
                                <button onclick="window.open('${sub.screenshot}', '_blank')" style="padding: 5px 10px; background: #3B82F6; color: white; border: none; border-radius: 4px;">
                                    Lihat Bukti
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                submissionsHTML += '</table>';
                
                const modal = window.open('', 'TaskSubmissions', 'width=900,height=600');
                modal.document.write(`
                    <html>
                    <head>
                        <title>Submissions: ${taskTitle}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            table { width: 100%; }
                            th { background: #F3F4F6; }
                            button { margin: 5px; }
                        </style>
                    </head>
                    <body>
                        ${submissionsHTML}
                        <br><br>
                        <button onclick="window.print()">Print</button>
                        <button onclick="window.close()">Tutup</button>
                    </body>
                    </html>
                `);
                
            } catch (error) {
                console.error("Error viewing task submissions:", error);
                alert('Gagal memuat data submissions.');
            }
        }

        // ===================================
        // 6. INITIAL LOAD
        // ===================================
        
        async function initialLoad() {
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                tasksSnapshot.forEach(doc => {
                    allTasks[doc.id] = doc.data();
                });
                
                loadDashboardStats();
                loadPendingTasks();
                loadPendingWithdraws();
                
                console.log("Admin panel loaded successfully");
                
            } catch (error) {
                console.error("Initial load error:", error);
            }
        }
        
        initialLoad();
        
    </script>
</body>
</html>
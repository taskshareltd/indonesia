<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar - TaskShare</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header style="text-align: center; margin-top: 40px; margin-bottom: 30px;">
            <h1 style="color: var(--color-primary);">TaskShare</h1>
            <p>Daftar dan Mulai Hasilkan Saldo!</p>
        </header>

        <div class="card">
            <h2>Buat Akun Baru</h2>
            <form id="register-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Kata Sandi (min 6 karakter)" required>
                <input type="text" id="referral-code" placeholder="Kode Referral (Opsional)">
                <button type="submit" class="btn-primary">Daftar Akun</button>
            </form>
            <p id="error-message" style="color: red; margin-top: 10px; text-align: center; display: none;">
                </p>
        </div>

        <p style="text-align: center; margin-top: 20px;">
            Sudah punya akun? <a href="index.html" style="color: var(--color-secondary); text-decoration: none; font-weight: 600;">Masuk di sini</a>
        </p>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        // Fungsi untuk mengambil parameter dari URL (untuk kode referral)
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Ambil kode referral dari URL (?ref=KODE) dan isi otomatis
        const urlRefCode = getUrlParameter('ref');
        if (urlRefCode) {
            document.getElementById('referral-code').value = urlRefCode;
        }

        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const referredByRefCode = document.getElementById('referral-code').value.trim();
            const errorMessageElement = document.getElementById('error-message');
            errorMessageElement.style.display = 'none';

            // 1. Pendaftaran menggunakan Firebase Auth
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;
                const userRefCode = uid.substring(0, 8).toUpperCase(); // Membuat kode referral unik (8 karakter pertama UID)

                let referrerUid = '';
                
                // 2. Cek dan Proses Referral
                if (referredByRefCode) {
                    // Cari user yang memiliki kode referral tersebut
                    const referrerSnapshot = await db.collection("users").where("referral", "==", referredByRefCode).limit(1).get();
                    
                    if (!referrerSnapshot.empty) {
                        referrerUid = referrerSnapshot.docs[0].id; // Ambil UID pengundang
                        
                        // Opsional: Langsung berikan reward ke pengundang (sesuai flow F. Referral)
                        const REFERRAL_REWARD = 500;
                        await db.collection("users").doc(referrerUid).update({
                            balance: firebase.firestore.FieldValue.increment(REFERRAL_REWARD)
                        });

                        // Buat riwayat referral
                        await db.collection("referrals").add({
                            newUser: uid,
                            referrer: referrerUid,
                            reward: REFERRAL_REWARD,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Buat riwayat saldo pengundang
                         await db.collection("history").add({
                            uid: referrerUid,
                            type: "referral",
                            amount: REFERRAL_REWARD,
                            description: `Bonus referral dari pendaftaran ${username}`,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    } else {
                         console.warn("Kode referral tidak ditemukan atau tidak valid.");
                    }
                }

                // 3. Buat Dokumen User di Firestore (sesuai Collection: users)
                await db.collection("users").doc(uid).set({
                    username: username,
                    email: email,
                    balance: 0, // Saldo awal 0
                    referral: userRefCode, // Kode referral user ini
                    referredBy: referrerUid, // UID pengundang (kosong jika tidak ada)
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert("Pendaftaran Berhasil! Anda akan diarahkan ke Dashboard.");
                window.location.href = 'dashboard.html';

            } catch (error) {
                // Tangani error pendaftaran (misalnya email sudah terdaftar, password lemah)
                console.error("Registration Error:", error);
                errorMessageElement.textContent = "Error: " + error.message;
                errorMessageElement.style.display = 'block';
            }
        });
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TaskShare</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .notification.success { background-color: #10B981; }
        .notification.error { background-color: #EF4444; }
        .notification.info { background-color: #3B82F6; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Shortcut Item */
        .shortcut-item {
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s;
        }
        .shortcut-item:hover {
            transform: translateY(-5px);
        }
        
        /* Check-in Button States */
        .btn-checkin {
            transition: all 0.3s;
        }
        .btn-checkin:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Balance Animation */
        @keyframes balancePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .balance-updated {
            animation: balancePulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <div class="container">
        <header style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Halo, <span id="username-display">User!</span></h2>
                    <p style="color: #64748B; font-size: 0.9em; margin-top: 5px;">
                        <i class="fas fa-id-card"></i> ID: <span id="user-id">...</span>
                    </p>
                </div>
                <a href="#" id="logout-button" class="btn-secondary" style="width: auto; padding: 8px 15px; font-size: 0.9em; background-color: #EF4444; color: white;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
            <p style="color: #64748B; margin-top: 10px;">Selamat datang di TaskShare, tempat tugas menghasilkan saldo!</p>
        </header>

        <!-- SALDO CARD -->
        <div class="card" id="balance-card" style="background: linear-gradient(135deg, var(--color-primary), #28a071); color: white; padding: 20px; text-align: center; border-radius: 16px;">
            <p style="font-size: 0.9rem; opacity: 0.9;"><i class="fas fa-wallet"></i> Saldo Anda Saat Ini</p>
            <h1 id="balance-display" style="margin: 10px 0; font-size: 2.5rem; font-weight: 700;">Rp 0</h1>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.9rem;">
                <div>
                    <p style="opacity: 0.8;">Total Klaim</p>
                    <p style="font-weight: 600;" id="total-checkins">0 hari</p>
                </div>
                <div style="border-left: 1px solid rgba(255,255,255,0.3); border-right: 1px solid rgba(255,255,255,0.3); padding: 0 20px;">
                    <p style="opacity: 0.8;">Total Tugas</p>
                    <p style="font-weight: 600;" id="total-tasks">0 tugas</p>
                </div>
                <div>
                    <p style="opacity: 0.8;">Total Referral</p>
                    <p style="font-weight: 600;" id="total-referrals">0 orang</p>
                </div>
            </div>
        </div>

        <!-- BONUS HARIAN SECTION -->
        <section class="card" style="margin-top: 20px; text-align: center; border-left: 4px solid var(--color-accent);">
            <h3 style="color: var(--color-accent);">
                <i class="fas fa-calendar-check"></i> Bonus Harian
            </h3>
            <p style="margin: 10px 0;">Klaim bonus <strong>Rp 150</strong> setiap hari!</p>
            
            <div id="checkin-info" style="margin-top: 15px; padding: 15px; background-color: #FFFBEB; border-radius: 10px; border: 1px solid #FDE68A;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-history" style="color: #D97706;"></i>
                    <p style="color: #92400E; font-size: 0.9em; margin: 0;">
                        Terakhir klaim: <strong id="last-checkin-date">Belum pernah</strong>
                    </p>
                </div>
            </div>
            
            <div id="checkin-timer" style="margin-top: 10px; padding: 10px; background-color: #F0F9FF; border-radius: 8px; display: none;">
                <p style="color: #0369A1; font-size: 0.9em; margin: 0;">
                    <i class="fas fa-clock"></i> Bisa klaim lagi: <span id="time-remaining">23:59:59</span>
                </p>
            </div>
            
            <p id="checkin-status" style="margin-top: 15px; font-weight: 600; color: #D97706;">
                <i class="fas fa-spinner fa-spin"></i> Memuat status check-in...
            </p>
            
            <button id="checkin-button" class="btn-primary btn-checkin" style="margin-top: 15px; padding: 14px 25px; font-size: 1rem; width: 100%;">
                <i class="fas fa-gift"></i> Klaim Bonus Harian (+Rp 150)
            </button>
            
            <p id="checkin-error" style="margin-top: 10px; color: #EF4444; display: none; font-size: 0.9em;"></p>
        </section>

        <!-- QUICK ACCESS -->
        <section style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">Akses Cepat</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <a href="tasks.html" class="card shortcut-item" style="text-align: center; padding: 20px; border-top: 4px solid var(--color-primary);">
                    <div style="background-color: #DCFCE7; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <i class="fas fa-clipboard-list" style="font-size: 1.5em; color: var(--color-primary);"></i>
                    </div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Tugas</p>
                    <p style="color: #64748B; font-size: 0.9em;">Kerjakan tugas & dapatkan saldo</p>
                </a>
                
                <a href="withdraw.html" class="card shortcut-item" style="text-align: center; padding: 20px; border-top: 4px solid var(--color-accent);">
                    <div style="background-color: #FEF3C7; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <i class="fas fa-money-bill-wave" style="font-size: 1.5em; color: var(--color-accent);"></i>
                    </div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Tarik Saldo</p>
                    <p style="color: #64748B; font-size: 0.9em;">Tarik ke e-wallet atau bank</p>
                </a>
                
                <a href="history.html" class="card shortcut-item" style="text-align: center; padding: 20px; border-top: 4px solid #8B5CF6;">
                    <div style="background-color: #EDE9FE; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <i class="fas fa-history" style="font-size: 1.5em; color: #8B5CF6;"></i>
                    </div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Riwayat</p>
                    <p style="color: #64748B; font-size: 0.9em;">Lihat semua transaksi</p>
                </a>
                
                <div class="card shortcut-item" style="text-align: center; padding: 20px; border-top: 4px solid #3B82F6; cursor: pointer;" onclick="showReferralModal()">
                    <div style="background-color: #DBEAFE; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <i class="fas fa-users" style="font-size: 1.5em; color: #3B82F6;"></i>
                    </div>
                    <p style="font-weight: 600; margin-bottom: 5px;">Undang Teman</p>
                    <p style="color: #64748B; font-size: 0.9em;">Dapatkan Rp 250 per orang</p>
                </div>
            </div>
        </section>

        <!-- REFERRAL PROGRAM -->
        <section class="card" style="margin-top: 30px; background: linear-gradient(135deg, #F3F4F6, #E5E7EB);">
            <h3 style="color: #7C3AED;">
                <i class="fas fa-users"></i> Program Undang Teman
            </h3>
            <p style="margin: 10px 0;">Dapatkan <strong>Rp 250</strong> untuk setiap teman yang mendaftar!</p>
            
            <div style="background: white; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="background-color: #8B5CF6; color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div>
                        <p style="font-size: 0.9em; color: #64748B; margin: 0;">Kode Referral Anda</p>
                        <p style="font-weight: 700; font-size: 1.2em; color: #1E293B; margin: 0;" id="referral-code">LOADING...</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <p style="font-weight: 600; margin-bottom: 8px;">Link Undangan:</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="referral-link-input" readonly 
                               style="flex: 1; padding: 12px; border: 1px solid #E2E8F0; border-radius: 8px; background: white; font-size: 0.9em;">
                        <button id="copy-referral-link" class="btn-primary" 
                                style="width: auto; padding: 12px 15px; white-space: nowrap;">
                            <i class="fas fa-copy"></i> Salin
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #CBD5E1;">
                <div style="text-align: center;">
                    <p style="font-size: 0.8em; color: #64748B;">Bonus per Orang</p>
                    <p style="font-weight: 700; color: #10B981;">Rp 250</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 0.8em; color: #64748B;">Minimal Withdraw</p>
                    <p style="font-weight: 700; color: #EF4444;">Rp 25.000</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 0.8em; color: #64748B;">Bonus Harian</p>
                    <p style="font-weight: 700; color: #F59E0B;">Rp 150</p>
                </div>
            </div>
        </section>
        
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item active">
            <i class="fas fa-home"></i><p>Home</p>
        </a>
        <a href="tasks.html" class="nav-item">
            <i class="fas fa-clipboard-list"></i><p>Tugas</p>
        </a>
        <a href="withdraw.html" class="nav-item">
            <i class="fas fa-money-bill-wave"></i><p>Tarik</p>
        </a>
        <a href="history.html" class="nav-item">
            <i class="fas fa-history"></i><p>Riwayat</p>
        </a>
    </nav>

    <!-- REFERRAL MODAL -->
    <div id="referral-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 400px; width: 90%; margin: 20px; position: relative;">
            <button onclick="closeReferralModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2em; color: #64748B; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="color: var(--color-primary); margin-bottom: 15px;">
                <i class="fas fa-share-alt"></i> Bagikan Kode Referral
            </h3>
            <p style="margin-bottom: 20px;">Salin dan bagikan link ini ke teman-teman Anda:</p>
            
            <div style="background: #F1F5F9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p id="modal-referral-link" style="word-break: break-all; font-size: 0.9em;"></p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="shareToWhatsApp()" style="padding: 12px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button onclick="shareToTelegram()" style="padding: 12px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fab fa-telegram"></i> Telegram
                </button>
            </div>
            
            <p style="font-size: 0.9em; color: #64748B; margin-top: 20px; text-align: center;">
                Setiap teman yang mendaftar = <strong>Rp 250</strong> untuk Anda!
            </p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        const usernameDisplay = document.getElementById('username-display');
        const userIdDisplay = document.getElementById('user-id');
        const balanceDisplay = document.getElementById('balance-display');
        const balanceCard = document.getElementById('balance-card');
        const referralCode = document.getElementById('referral-code');
        const referralLinkInput = document.getElementById('referral-link-input');
        const copyReferralLinkButton = document.getElementById('copy-referral-link');
        const logoutButton = document.getElementById('logout-button');
        const checkinButton = document.getElementById('checkin-button');
        const checkinStatus = document.getElementById('checkin-status');
        const checkinError = document.getElementById('checkin-error');
        const lastCheckinDate = document.getElementById('last-checkin-date');
        const checkinTimer = document.getElementById('checkin-timer');
        const timeRemaining = document.getElementById('time-remaining');
        const totalCheckins = document.getElementById('total-checkins');
        const totalTasks = document.getElementById('total-tasks');
        const totalReferrals = document.getElementById('total-referrals');
        const modalReferralLink = document.getElementById('modal-referral-link');
        const referralModal = document.getElementById('referral-modal');
        
        const DAILY_BONUS_AMOUNT = 150;
        let currentUid = null;
        let userLastCheckin = null;
        let checkinInterval = null;
        let userReferralCode = '';

        // ============================================
        // INITIALIZATION & AUTH
        // ============================================
        
        // Clear old cache on load
        localStorage.removeItem('lastCheckinCache');
        console.log("Dashboard initialized - Cache cleared");
        
        // Auth State Listener dengan error handling
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                console.log("No user found, redirecting to login");
                window.location.href = 'index.html';
                return;
            }
            
            currentUid = user.uid;
            console.log("User authenticated:", currentUid);
            userIdDisplay.textContent = currentUid.substring(0, 8) + '...';
            
            try {
                // Load initial user data
                await loadUserData();
                
                // Load additional stats
                await loadUserStats();
                
                // Setup referral link
                setupReferralLink();
                
                // Start check-in timer
                updateCheckinTimer();
                checkinInterval = setInterval(updateCheckinTimer, 1000);
                
            } catch (error) {
                console.error("Error in auth state change:", error);
                showNotification("Gagal memuat data. Silakan refresh halaman.", "error");
            }
        });

        // ============================================
        // LOAD USER DATA
        // ============================================
        async function loadUserData() {
            try {
                const userDoc = await db.collection("users").doc(currentUid).get();
                
                if (!userDoc.exists) {
                    throw new Error("Data user tidak ditemukan");
                }
                
                const userData = userDoc.data();
                
                // Update UI
                usernameDisplay.textContent = userData.username || userData.email;
                
                const balance = userData.balance || 0;
                balanceDisplay.textContent = formatCurrency(balance);
                
                userReferralCode = userData.referral || 'N/A';
                referralCode.textContent = userReferralCode;
                
                // Handle last check-in
                if (userData.lastCheckin) {
                    userLastCheckin = userData.lastCheckin.toDate();
                    const formattedDate = formatDateTime(userLastCheckin);
                    lastCheckinDate.textContent = formattedDate;
                    
                    // Check if already checked in today
                    const canCheckin = !isSameDay(userLastCheckin, new Date());
                    updateCheckinButton(canCheckin);
                } else {
                    userLastCheckin = null;
                    lastCheckinDate.textContent = "Belum pernah";
                    updateCheckinButton(true);
                }
                
            } catch (error) {
                console.error("Error loading user data:", error);
                throw error;
            }
        }
        
        // ============================================
        // LOAD USER STATS
        // ============================================
        async function loadUserStats() {
            try {
                // Load total check-ins from history
                const checkinsSnapshot = await db.collection("history")
                    .where("uid", "==", currentUid)
                    .where("type", "==", "daily_checkin")
                    .get();
                totalCheckins.textContent = `${checkinsSnapshot.size} hari`;
                
                // Load completed tasks
                const tasksSnapshot = await db.collection("user_tasks")
                    .where("uid", "==", currentUid)
                    .where("status", "==", "approved")
                    .get();
                totalTasks.textContent = `${tasksSnapshot.size} tugas`;
                
                // Load referrals
                const referralsSnapshot = await db.collection("users")
                    .where("referredBy", "==", currentUid)
                    .get();
                totalReferrals.textContent = `${referralsSnapshot.size} orang`;
                
            } catch (error) {
                console.error("Error loading user stats:", error);
                // Don't throw, just show defaults
            }
        }

        // ============================================
        // CHECK-IN SYSTEM (FIXED VERSION)
        // ============================================
        function updateCheckinButton(canCheckin) {
            if (canCheckin) {
                checkinStatus.innerHTML = '<i class="fas fa-gift" style="color: var(--color-primary);"></i> Siap! Klaim bonus harian Anda sekarang.';
                checkinStatus.style.color = 'var(--color-primary)';
                checkinButton.disabled = false;
                checkinButton.innerHTML = '<i class="fas fa-gift"></i> Klaim Bonus Harian (+Rp 150)';
                checkinButton.style.backgroundColor = 'var(--color-primary)';
                checkinTimer.style.display = 'none';
            } else {
                checkinStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #10B981;"></i> Anda sudah klaim bonus hari ini.';
                checkinStatus.style.color = '#10B981';
                checkinButton.disabled = true;
                checkinButton.innerHTML = '<i class="fas fa-check"></i> Sudah Diklaim';
                checkinButton.style.backgroundColor = '#94A3B8';
                checkinTimer.style.display = 'block';
            }
        }
        
        function updateCheckinTimer() {
            if (!userLastCheckin) return;
            
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const timeLeft = tomorrow.getTime() - now.getTime();
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            timeRemaining.textContent = 
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
        }
        
        checkinButton.addEventListener('click', async () => {
            if (checkinButton.disabled) return;
            
            const originalText = checkinButton.innerHTML;
            checkinButton.disabled = true;
            checkinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            checkinError.style.display = 'none';
            
            try {
                // 1. Verify user can check in
                const userDoc = await db.collection("users").doc(currentUid).get();
                if (!userDoc.exists) {
                    throw new Error("User tidak ditemukan");
                }
                
                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;
                
                // Double check if already checked in today
                if (userData.lastCheckin) {
                    const lastCheckin = userData.lastCheckin.toDate();
                    if (isSameDay(lastCheckin, new Date())) {
                        throw new Error("Anda sudah check-in hari ini");
                    }
                }
                
                // 2. Prepare updates using batch (lebih reliable dari transaction)
                const batch = db.batch();
                const userRef = db.collection("users").doc(currentUid);
                const historyRef = db.collection("history").doc();
                
                // Update user balance and lastCheckin
                batch.update(userRef, {
                    balance: currentBalance + DAILY_BONUS_AMOUNT,
                    lastCheckin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add history record
                batch.set(historyRef, {
                    uid: currentUid,
                    type: "daily_checkin",
                    amount: DAILY_BONUS_AMOUNT,
                    description: "Bonus Klaim Harian",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 3. Execute batch
                await batch.commit();
                
                // 4. Update UI immediately
                const newBalance = currentBalance + DAILY_BONUS_AMOUNT;
                balanceDisplay.textContent = formatCurrency(newBalance);
                balanceCard.classList.add('balance-updated');
                setTimeout(() => balanceCard.classList.remove('balance-updated'), 500);
                
                lastCheckinDate.textContent = formatDateTime(new Date());
                userLastCheckin = new Date();
                
                // 5. Show success
                showNotification(`Berhasil! +Rp ${DAILY_BONUS_AMOUNT} telah ditambahkan`, "success");
                
                // 6. Update button state
                updateCheckinButton(false);
                
                // 7. Update stats
                const currentCheckins = parseInt(totalCheckins.textContent) || 0;
                totalCheckins.textContent = `${currentCheckins + 1} hari`;
                
            } catch (error) {
                console.error("Check-in error:", error);
                
                let errorMsg = "Gagal klaim bonus";
                if (error.message.includes("sudah check-in")) {
                    errorMsg = "Anda sudah check-in hari ini";
                    updateCheckinButton(false);
                } else if (error.code === 'permission-denied') {
                    errorMsg = "Akses ditolak. Coba login ulang";
                }
                
                checkinError.textContent = errorMsg;
                checkinError.style.display = 'block';
                checkinButton.disabled = false;
                checkinButton.innerHTML = originalText;
                
                showNotification(errorMsg, "error");
            }
        });

        // ============================================
        // REFERRAL SYSTEM
        // ============================================
        function setupReferralLink() {
            const baseUrl = window.location.origin + window.location.pathname
                .replace('dashboard.html', '')
                .replace('index.html', '');
            
            const referralLink = baseUrl + 'index.html?ref=' + userReferralCode;
            referralLinkInput.value = referralLink;
            modalReferralLink.textContent = referralLink;
        }
        
        copyReferralLinkButton.addEventListener('click', () => {
            const link = referralLinkInput.value;
            navigator.clipboard.writeText(link).then(() => {
                showNotification("Link berhasil disalin!", "success");
            }).catch(err => {
                console.error("Copy failed:", err);
                showNotification("Gagal menyalin link", "error");
            });
        });
        
        function showReferralModal() {
            referralModal.style.display = 'flex';
        }
        
        function closeReferralModal() {
            referralModal.style.display = 'none';
        }
        
        function shareToWhatsApp() {
            const text = `Join TaskShare dan dapatkan saldo! Gunakan kode referral saya: ${userReferralCode}\n\n${referralLinkInput.value}`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }
        
        function shareToTelegram() {
            const text = `Join TaskShare dan dapatkan saldo! Gunakan kode referral saya: ${userReferralCode}\n\n${referralLinkInput.value}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(referralLinkInput.value)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // ============================================
        // LOGOUT
        // ============================================
        logoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            
            if (confirm("Yakin ingin logout?")) {
                try {
                    // Clear interval
                    if (checkinInterval) {
                        clearInterval(checkinInterval);
                    }
                    
                    // Sign out
                    await auth.signOut();
                    
                    // Clear local storage
                    localStorage.clear();
                    
                    // Redirect
                    window.location.href = 'index.html';
                    
                } catch (error) {
                    console.error("Logout error:", error);
                    showNotification("Gagal logout", "error");
                }
            }
        });

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDateTime(date) {
            return date.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }
        
        function showNotification(message, type = "info") {
            // Remove existing notifications
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notif => notif.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            
            document.getElementById('notification-container').appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ============================================
        // CLEANUP ON PAGE UNLOAD
        // ============================================
        window.addEventListener('beforeunload', () => {
            if (checkinInterval) {
                clearInterval(checkinInterval);
            }
        });

        // ============================================
        // DEBUG FUNCTIONS (optional)
        // ============================================
        window.debugCheckin = async () => {
            console.log("=== DEBUG INFO ===");
            console.log("Current UID:", currentUid);
            console.log("Last Checkin:", userLastCheckin);
            console.log("Today:", new Date());
            
            const userDoc = await db.collection("users").doc(currentUid).get();
            console.log("Firestore Data:", userDoc.data());
        };

        console.log("Dashboard script loaded successfully");
        
    </script>
</body>
</html>
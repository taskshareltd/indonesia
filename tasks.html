<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tugas Harian - TaskShare</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Caption Box Styling */
        .caption-box-user {
            background: #F0F9FF;
            border: 2px dashed #3B82F6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
        }
        
        .caption-text {
            width: 100%;
            min-height: 100px;
            border: 1px solid #CBD5E1;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
            background: white;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .copy-caption-btn-user {
            padding: 8px 15px;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .copy-caption-btn-user:hover {
            background: #2563EB;
        }
        
        .copy-caption-btn-user:disabled {
            background: #94A3B8;
            cursor: not-allowed;
        }
        
        /* Task Card */
        .task-card-user {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-primary);
        }
        
        /* Get Image Button */
        .get-image-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .get-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }
        
        .status-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }
        
        .status-info {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #BFDBFE;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending { background: #FEF3C7; color: #92400E; }
        .status-approved { background: #D1FAE5; color: #065F46; }
        .status-rejected { background: #FEE2E2; color: #991B1B; }
        
        /* Upload Preview */
        .upload-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px dashed #E2E8F0;
            display: none;
        }
        
        /* Action Buttons */
        .action-button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .btn-blue {
            background: #3B82F6;
            color: white;
        }
        
        .btn-blue:hover {
            background: #2563EB;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <header style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="color: var(--color-primary);">Daftar Tugas Tersedia</h2>
                    <p>Selesaikan tugas dan dapatkan saldo setelah diverifikasi Admin</p>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 0.9em; color: #64748B;">Saldo Anda:</p>
                    <p id="user-balance" style="color: var(--color-primary); font-weight: 700; font-size: 1.2em;">Rp 0</p>
                </div>
            </div>
        </header>

        <!-- TASKS LIST -->
        <section id="task-list">
            <p style="text-align: center; color: #64748B;">
                <i class="fas fa-spinner fa-spin"></i> Memuat tugas...
            </p>
        </section>

        <!-- SUBMIT TASK FORM -->
        <section class="card" id="submission-form-section" style="margin-top: 30px;">
            <h3><i class="fas fa-paper-plane"></i> Submit Bukti Tugas</h3>
            
            <form id="task-submission-form">
                <!-- Pilih Tugas -->
                <div style="margin-bottom: 15px;">
                    <label for="task-select" style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="fas fa-clipboard-list"></i> Pilih Tugas:
                    </label>
                    <select id="task-select" required
                            style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 1em;">
                        <option value="">-- Pilih salah satu tugas --</option>
                    </select>
                </div>
                
                <!-- Caption yang Harus Digunakan -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="fas fa-quote-right"></i> Caption yang Harus Digunakan:
                    </label>
                    <div class="caption-box-user">
                        <div class="caption-text" id="caption-display">
                            Pilih tugas terlebih dahulu untuk melihat caption
                        </div>
                        <button type="button" class="copy-caption-btn-user" id="copy-caption-btn" disabled>
                            <i class="fas fa-copy"></i> Salin Caption
                        </button>
                    </div>
                </div>
                
                <!-- Ambil Gambar -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="fas fa-image"></i> Ambil Gambar Tugas:
                    </label>
                    <a href="#" id="get-image-btn" class="get-image-btn" target="_blank" style="display: none;">
                        <i class="fas fa-download"></i> Ambil Gambar Disini
                    </a>
                    <p id="image-info" style="color: #64748B; font-size: 0.9em; margin-top: 5px;">
                        Klik tombol di atas untuk mendapatkan gambar tugas
                    </p>
                </div>
                
                <!-- Upload Screenshot -->
                <div style="margin-bottom: 20px;">
                    <label for="screenshot-file" style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="fas fa-upload"></i> Upload Screenshot Bukti:
                    </label>
                    <input type="file" id="screenshot-file" accept="image/*" required
                           style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px;">
                    
                    <!-- Preview Image -->
                    <img id="upload-preview" class="upload-preview" alt="Preview">
                    
                    <p style="color: #64748B; font-size: 0.8em; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Upload screenshot bukti Anda telah menyelesaikan tugas
                    </p>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="btn-primary" id="submit-button" style="padding: 14px 20px; font-size: 1.1rem;">
                    <i class="fas fa-paper-plane"></i> Kirim Bukti Tugas
                </button>
                
                <div id="submission-status" style="margin-top: 15px;"></div>
            </form>
        </section>
        
        <!-- STATUS TUGAS SAYA -->
        <section class="card" style="margin-top: 20px;">
            <h3><i class="fas fa-history"></i> Status Tugas Saya</h3>
            <div id="user-task-status">
                <p style="color: #64748B; text-align: center;">
                    <i class="fas fa-spinner fa-spin"></i> Memuat status tugas...
                </p>
            </div>
        </section>
        
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i><p>Home</p>
        </a>
        <a href="tasks.html" class="nav-item active">
            <i class="fas fa-clipboard-list"></i><p>Tugas</p>
        </a>
        <a href="withdraw.html" class="nav-item">
            <i class="fas fa-money-bill-wave"></i><p>Tarik</p>
        </a>
        <a href="history.html" class="nav-item">
            <i class="fas fa-history"></i><p>Riwayat</p>
        </a>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // FIREBASE CONFIG - SIMPLE VERSION
        const firebaseConfig = {
            apiKey: "AIzaSyAXBhH6C0gzuh_ErtSwgch40Xzkum7H2pA",
            authDomain: "taskshare-production.firebaseapp.com",
            projectId: "taskshare-production",
            storageBucket: "taskshare-production.firebasestorage.app",
            messagingSenderId: "552032745720",
            appId: "1:552032745720:web:1444005dfc80ad02c0230d",
            measurementId: "G-Y72K3DLK64"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log("✅ Tasks page Firebase initialized");
    </script>
    
    <script>
        // ===================================================
        // TASKS PAGE - FIXED VERSION (NO INDEX ERROR)
        // ===================================================
        
        // Elements
        const taskListContainer = document.getElementById('task-list');
        const taskSelect = document.getElementById('task-select');
        const captionDisplay = document.getElementById('caption-display');
        const copyCaptionBtn = document.getElementById('copy-caption-btn');
        const getImageBtn = document.getElementById('get-image-btn');
        const imageInfo = document.getElementById('image-info');
        const screenshotFile = document.getElementById('screenshot-file');
        const uploadPreview = document.getElementById('upload-preview');
        const submitButton = document.getElementById('submit-button');
        const submissionStatus = document.getElementById('submission-status');
        const userTaskStatusContainer = document.getElementById('user-task-status');
        const userBalance = document.getElementById('user-balance');
        
        // Variables
        let currentUid = null;
        let availableTasks = {};
        const IMGBB_API_KEY = "4a8d88aeac88b452c19e45cd77ea771d";
        
        // ===================================================
        // 1. AUTH CHECK & INIT - FIXED
        // ===================================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUid = user.uid;
            console.log("User authenticated:", currentUid);
            
            try {
                // Load user balance
                const userDoc = await db.collection("users").doc(currentUid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance.textContent = formatCurrency(userData.balance || 0);
                }
                
                // Load all data
                await loadTasks();  // FIXED: No complex query
                await loadUserTaskStatus(); // FIXED: Simple query
                
            } catch (error) {
                console.error("Auth check error:", error);
                showSubmissionStatus(`❌ Error: ${error.message}`, 'error');
            }
        });
        
        // ===================================================
        // 2. LOAD AVAILABLE TASKS - FIXED (NO INDEX NEEDED)
        // ===================================================
        async function loadTasks() {
            try {
                // SIMPLE QUERY - NO WHERE/ORDERBY that needs index
                const snapshot = await db.collection("tasks").get();
                
                taskListContainer.innerHTML = '';
                taskSelect.innerHTML = '<option value="">-- Pilih salah satu tugas --</option>';
                
                if (snapshot.empty) {
                    taskListContainer.innerHTML = `
                        <div class="card" style="text-align: center; padding: 30px;">
                            <i class="fas fa-clipboard-list" style="font-size: 3em; color: #E2E8F0; margin-bottom: 15px;"></i>
                            <h3 style="color: #64748B;">Belum Ada Tugas</h3>
                            <p>Admin belum menambahkan tugas. Silakan cek kembali nanti.</p>
                        </div>
                    `;
                    return;
                }
                
                // Store tasks and display
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskId = doc.id;
                    availableTasks[taskId] = task;
                    
                    // Check if task is active (default true if not specified)
                    const isActive = task.active !== false;
                    
                    // Only show active tasks
                    if (isActive) {
                        // Display task card
                        const rewardFormatted = formatCurrency(task.reward);
                        
                        taskListContainer.innerHTML += `
                            <div class="task-card-user">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 10px 0;">${task.title}</h4>
                                        <p style="color: #64748B; margin: 0 0 15px 0;">${task.description}</p>
                                        
                                        <div style="display: flex; gap: 15px; align-items: center;">
                                            <span style="color: var(--color-accent); font-weight: 700; font-size: 1.2em;">
                                                ${rewardFormatted}
                                            </span>
                                            <button onclick="selectTask('${taskId}')" 
                                                    class="action-button btn-blue">
                                                <i class="fas fa-check"></i> Pilih Tugas Ini
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Add to dropdown
                        taskSelect.innerHTML += `<option value="${taskId}">${task.title} (${rewardFormatted})</option>`;
                    }
                });
                
                console.log(`✅ Loaded ${Object.keys(availableTasks).length} active tasks`);
                
                if (taskListContainer.innerHTML === '') {
                    taskListContainer.innerHTML = `
                        <div class="status-message status-info">
                            <i class="fas fa-info-circle"></i> Tidak ada tugas aktif saat ini.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Error loading tasks:", error);
                taskListContainer.innerHTML = `
                    <div class="status-message status-error">
                        <i class="fas fa-exclamation-triangle"></i> Gagal memuat daftar tugas. Silakan refresh halaman.
                    </div>
                `;
            }
        }
        
        // ===================================================
        // 3. TASK SELECTION HANDLING
        // ===================================================
        window.selectTask = function(taskId) {
            taskSelect.value = taskId;
            handleTaskSelection(taskId);
        };
        
        taskSelect.addEventListener('change', function() {
            const taskId = this.value;
            handleTaskSelection(taskId);
        });
        
        function handleTaskSelection(taskId) {
            const task = availableTasks[taskId];
            
            if (!task) {
                captionDisplay.textContent = 'Pilih tugas terlebih dahulu untuk melihat caption';
                copyCaptionBtn.disabled = true;
                getImageBtn.style.display = 'none';
                return;
            }
            
            // Show caption
            captionDisplay.textContent = task.caption || 'Tidak ada caption khusus.';
            copyCaptionBtn.disabled = false;
            
            // Show get image button if image exists
            if (task.image) {
                getImageBtn.href = task.image;
                getImageBtn.style.display = 'inline-flex';
                imageInfo.textContent = 'Klik tombol di atas untuk membuka gambar tugas';
            } else {
                getImageBtn.style.display = 'none';
                imageInfo.textContent = 'Tidak ada gambar untuk tugas ini';
            }
        }
        
        // ===================================================
        // 4. COPY CAPTION FUNCTION
        // ===================================================
        copyCaptionBtn.addEventListener('click', function() {
            const captionText = captionDisplay.textContent;
            
            if (captionText && captionText !== 'Pilih tugas terlebih dahulu untuk melihat caption') {
                navigator.clipboard.writeText(captionText).then(() => {
                    showSubmissionStatus('✅ Caption berhasil disalin!', 'success');
                }).catch(err => {
                    console.error('Copy failed:', err);
                    showSubmissionStatus('❌ Gagal menyalin caption', 'error');
                });
            } else {
                showSubmissionStatus('⚠️ Tidak ada caption untuk disalin', 'error');
            }
        });
        
        // ===================================================
        // 5. UPLOAD PREVIEW
        // ===================================================
        screenshotFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadPreview.src = e.target.result;
                    uploadPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // ===================================================
        // 6. SUBMIT TASK FORM - FIXED
        // ===================================================
        document.getElementById('task-submission-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedTaskId = taskSelect.value;
            const file = screenshotFile.files[0];
            
            if (!selectedTaskId) {
                showSubmissionStatus('❌ Pilih tugas yang ingin Anda kirim', 'error');
                return;
            }
            
            if (!file) {
                showSubmissionStatus('❌ Pilih file screenshot bukti', 'error');
                return;
            }
            
            const task = availableTasks[selectedTaskId];
            if (!task) {
                showSubmissionStatus('❌ Data tugas tidak valid', 'error');
                return;
            }
            
            // Disable button
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengupload...';
            
            try {
                showSubmissionStatus('<i class="fas fa-spinner fa-spin"></i> Mengupload gambar...', 'info');
                
                // Upload to ImgBB
                const imageUrl = await uploadToImgBB(file);
                
                // Save to Firestore
                await db.collection("user_tasks").add({
                    uid: currentUid,
                    taskId: selectedTaskId,
                    screenshot: imageUrl,
                    status: "pending",
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reward: task.reward,
                    taskTitle: task.title
                });
                
                // Success
                showSubmissionStatus('✅ Bukti tugas berhasil dikirim! Menunggu verifikasi Admin.', 'success');
                
                // Reset form
                document.getElementById('task-submission-form').reset();
                uploadPreview.style.display = 'none';
                captionDisplay.textContent = 'Pilih tugas terlebih dahulu untuk melihat caption';
                copyCaptionBtn.disabled = true;
                getImageBtn.style.display = 'none';
                
                // Refresh status
                setTimeout(() => {
                    loadUserTaskStatus();
                }, 1000);
                
            } catch (error) {
                console.error("Submission error:", error);
                showSubmissionStatus(`❌ Gagal mengirim tugas: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });
        
        // ===================================================
        // 7. LOAD USER TASK STATUS - FIXED (Simple Query)
        // ===================================================
        async function loadUserTaskStatus() {
            try {
                // SIMPLE QUERY - Get all user tasks
                const snapshot = await db.collection("user_tasks")
                    .where("uid", "==", currentUid)
                    .get(); // NO ORDERBY that needs index
                
                userTaskStatusContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    userTaskStatusContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-inbox" style="font-size: 2em; color: #E2E8F0;"></i>
                            <p style="color: #64748B;">Belum ada tugas yang dikirim</p>
                        </div>
                    `;
                    return;
                }
                
                // Convert to array and sort manually
                const submissions = [];
                snapshot.forEach(doc => {
                    const submission = doc.data();
                    submission.id = doc.id;
                    submissions.push(submission);
                });
                
                // Sort by date manually
                submissions.sort((a, b) => {
                    const dateA = a.submittedAt?.seconds || 0;
                    const dateB = b.submittedAt?.seconds || 0;
                    return dateB - dateA; // Newest first
                });
                
                // Display only latest 5
                const recentSubmissions = submissions.slice(0, 5);
                
                recentSubmissions.forEach(submission => {
                    const task = availableTasks[submission.taskId];
                    const taskTitle = task ? task.title : submission.taskTitle || 'Tugas Tidak Dikenal';
                    const reward = task ? formatCurrency(task.reward) : formatCurrency(submission.reward || 0);
                    
                    let statusClass = 'status-pending';
                    let statusIcon = '⏳';
                    if (submission.status === 'approved') {
                        statusClass = 'status-approved';
                        statusIcon = '✅';
                    } else if (submission.status === 'rejected') {
                        statusClass = 'status-rejected';
                        statusIcon = '❌';
                    }
                    
                    const date = submission.submittedAt ? 
                        formatDate(submission.submittedAt) : 'Tanggal tidak tersedia';
                    
                    userTaskStatusContainer.innerHTML += `
                        <div style="padding: 15px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">${taskTitle}</p>
                                <p style="color: #64748B; font-size: 0.9em; margin: 0 0 5px 0;">
                                    ${date} • ${reward}
                                </p>
                                <span class="status-badge ${statusClass}">
                                    ${statusIcon} ${submission.status.toUpperCase()}
                                </span>
                            </div>
                            <button onclick="viewScreenshot('${submission.screenshot}')" 
                                    class="action-button btn-blue">
                                <i class="fas fa-eye"></i> Lihat
                            </button>
                        </div>
                    `;
                });
                
                if (submissions.length > 5) {
                    userTaskStatusContainer.innerHTML += `
                        <div style="text-align: center; padding: 10px; color: #64748B; font-size: 0.9em;">
                            +${submissions.length - 5} tugas lainnya
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Error loading user tasks:", error);
                userTaskStatusContainer.innerHTML = `
                    <div class="status-message status-error">
                        Gagal memuat status tugas: ${error.message}
                    </div>
                `;
            }
        }
        
        // ===================================================
        // 8. HELPER FUNCTIONS
        // ===================================================
        window.viewScreenshot = function(url) {
            window.open(url, '_blank');
        };
        
        function showSubmissionStatus(message, type) {
            submissionStatus.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Tanggal tidak valid';
            }
        }
        
        // Upload to ImgBB
        async function uploadToImgBB(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const base64 = reader.result.split(',')[1];
                        const formData = new FormData();
                        formData.append('image', base64);
                        
                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            resolve(result.data.url);
                        } else {
                            reject(new Error(result.error?.message || 'Upload failed'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('File read error'));
            });
        }
        
        console.log("✅ Tasks page loaded successfully - FIXED VERSION");
        
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tugas Harian - TaskShare</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    
    <div class="container">
        <header style="margin-bottom: 20px;">
            <h2 style="color: var(--color-primary);">Daftar Tugas Tersedia</h2>
            <p>Selesaikan tugas di bawah ini dan dapatkan saldo setelah diverifikasi Admin.</p>
        </header>

        <section id="task-list">
            <p style="text-align: center; color: #64748B;">Memuat tugas...</p>
        </section>

        <section class="card" id="submission-form-section" style="margin-top: 30px;">
            <h3>Submit Bukti Tugas</h3>
            <form id="task-submission-form">
                <label for="task-select">Pilih Tugas:</label>
                <select id="task-select" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px;">
                    <option value="">-- Pilih salah satu tugas --</option>
                </select>

                <label for="caption-display">Caption yang Harus Digunakan:</label>
                <textarea id="caption-display" readonly style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #E2E8F0; background-color: #F1F5F9; font-size: 0.9em; min-height: 80px;"></textarea>
                
                <label for="screenshot-file">Upload Screenshot Bukti:</label>
                <input type="file" id="screenshot-file" accept="image/*" required style="margin-bottom: 20px;">
                
                <button type="submit" class="btn-primary" id="submit-button">
                    Kirim Bukti Tugas
                </button>
                <p id="submission-status" style="margin-top: 10px; text-align: center; color: red;"></p>
            </form>
        </section>
        
        <section class="card" style="margin-top: 20px;">
            <h3>Status Tugas Saya</h3>
            <div id="user-task-status">
                <p style="color: #64748B;">Memuat status tugas...</p>
            </div>
        </section>
        
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i><p>Home</p>
        </a>
        <a href="tasks.html" class="nav-item active">
            <i class="fas fa-clipboard-list"></i><p>Tugas</p>
        </a>
        <a href="withdraw.html" class="nav-item">
            <i class="fas fa-money-bill-wave"></i><p>Tarik</p>
        </a>
        <a href="history.html" class="nav-item">
            <i class="fas fa-history"></i><p>Riwayat</p>
        </a>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        // PASTIKAN API KEY INI BENAR
        const IMGBB_API_KEY = "4a8d88aeac88b452c19e45cd77ea771d"; 
        const taskListContainer = document.getElementById('task-list');
        const taskSelect = document.getElementById('task-select');
        const submissionForm = document.getElementById('task-submission-form');
        const screenshotFile = document.getElementById('screenshot-file');
        const submitButton = document.getElementById('submit-button');
        const submissionStatus = document.getElementById('submission-status');
        const captionDisplay = document.getElementById('caption-display');
        const userTaskStatusContainer = document.getElementById('user-task-status');

        let currentUid = null;
        let availableTasks = {}; 

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUid = user.uid;
            loadTasks();
            loadUserTaskStatus(currentUid);
        });

        // 1. Load Tugas yang Tersedia
        async function loadTasks() {
            try {
                const snapshot = await db.collection("tasks").get();
                taskListContainer.innerHTML = '';
                taskSelect.innerHTML = '<option value="">-- Pilih salah satu tugas --</option>';

                if (snapshot.empty) {
                    taskListContainer.innerHTML = '<p style="text-align: center;">Tidak ada tugas yang tersedia saat ini.</p>';
                }

                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskId = doc.id;
                    availableTasks[taskId] = task; 
                    // Tampilkan tugas yang dimuat di sini...
                    taskListContainer.innerHTML += `
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4>${task.title}</h4>
                                <span style="color: var(--color-accent); font-weight: 600;">+Rp ${task.reward.toLocaleString('id-ID')}</span>
                            </div>
                            <p style="margin-top: 5px; color: #64748B;">${task.description}</p>
                            ${task.image ? `<img src="${task.image}" alt="Petunjuk Tugas" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : ''}
                        </div>
                    `;

                    taskSelect.innerHTML += `<option value="${taskId}">${task.title} (+Rp ${task.reward.toLocaleString('id-ID')})</option>`;
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                taskListContainer.innerHTML = '<p style="color: red;">Gagal memuat daftar tugas.</p>';
            }
        }
        
        taskSelect.addEventListener('change', () => {
            const taskId = taskSelect.value;
            if (taskId && availableTasks[taskId]) {
                captionDisplay.value = availableTasks[taskId].caption || 'Tidak ada caption khusus.';
                captionDisplay.style.height = (captionDisplay.scrollHeight) + 'px';
            } else {
                captionDisplay.value = '';
            }
        });


        // 2. Load Status Tugas User
        function loadUserTaskStatus(uid) {
            // Membutuhkan Index: user_tasks -> uid (Asc), submittedAt (Desc)
            db.collection("user_tasks")
              .where("uid", "==", uid)
              .orderBy("submittedAt", "desc")
              .limit(5)
              .onSnapshot(snapshot => {
                userTaskStatusContainer.innerHTML = '';
                if (snapshot.empty) {
                    userTaskStatusContainer.innerHTML = '<p>Anda belum pernah mengirimkan bukti tugas.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const submission = doc.data();
                    let statusColor = '';
                    if (submission.status === 'pending') statusColor = 'orange';
                    if (submission.status === 'approved') statusColor = 'var(--color-primary)';
                    if (submission.status === 'rejected') statusColor = 'red';
                    
                    // Gunakan availableTasks untuk mendapatkan judul
                    const taskTitle = availableTasks[submission.taskId] ? availableTasks[submission.taskId].title : 'Tugas Tidak Dikenal';

                    userTaskStatusContainer.innerHTML += `
                        <div style="padding: 10px 0; border-bottom: 1px solid #E2E8F0;">
                            <p><strong>${taskTitle}</strong></p>
                            <p style="font-size: 0.9em; color: ${statusColor};">Status: ${submission.status.toUpperCase()}</p>
                            <p style="font-size: 0.8em; color: #94A3B8;">Dikirim: ${submission.submittedAt ? new Date(submission.submittedAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    `;
                });
              }, error => {
                console.error("Error loading user tasks:", error);
                userTaskStatusContainer.innerHTML = '<p style="color: red;">Gagal memuat status tugas. Cek konsol Anda.</p>';
              });
        }


        // 3. Form Submission Handler (Mencakup ImgBB Upload)
        submissionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            submissionStatus.textContent = '';
            
            const selectedTaskId = taskSelect.value;
            const file = screenshotFile.files[0];

            if (!selectedTaskId) {
                submissionStatus.textContent = 'Pilih tugas yang ingin Anda kirim.';
                return;
            }
            if (!file) {
                submissionStatus.textContent = 'Pilih file screenshot bukti.';
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Mengupload Gambar...';
            submissionStatus.style.color = 'var(--color-secondary)';
            submissionStatus.textContent = 'Proses upload sedang berlangsung, mohon tunggu...';

            try {
                const base64String = await convertFileToBase64(file);
                const imageUrl = await uploadToImgBB(base64String);

                // --- PENTING: Penyimpanan Data ke Firestore ---
                await db.collection("user_tasks").add({
                    uid: currentUid,
                    taskId: selectedTaskId,
                    screenshot: imageUrl,
                    status: "pending", // Status harus "pending"
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp() // Timestamp harus dibuat
                });

                submissionStatus.style.color = 'var(--color-primary)';
                submissionStatus.textContent = 'Bukti tugas berhasil dikirim! Menunggu verifikasi Admin.';
                submissionForm.reset();
                captionDisplay.value = ''; 
                
            } catch (error) {
                console.error("Submission Error:", error);
                submissionStatus.style.color = 'red';
                submissionStatus.textContent = `Gagal mengirim tugas: ${error.message || "Terjadi kesalahan tidak terduga."}`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Kirim Bukti Tugas';
            }
        });

        // --- Fungsi Helper: Konversi File ke Base64 ---
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1]; 
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // --- Fungsi Helper: Upload ke ImgBB ---
        async function uploadToImgBB(base64String) {
            const form = new FormData();
            form.append("image", base64String);

            const response = await fetch("https://api.imgbb.com/1/upload?key=" + IMGBB_API_KEY, {
                method: "POST",
                body: form
            });

            const result = await response.json();

            if (result.success && result.data && result.data.url) {
                return result.data.url;
            } else {
                throw new Error(result.error ? result.error.message : "Gagal mengupload gambar ke ImgBB.");
            }
        }
    </script>
</body>
</html>
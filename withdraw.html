<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penarikan Saldo - TaskShare</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    
    <div class="container">
        <header style="margin-bottom: 20px;">
            <h2 style="color: var(--color-accent);"><i class="fas fa-wallet"></i> Tarik Saldo</h2>
            <p>Ajukan penarikan dana ke e-wallet atau rekening bank Anda.</p>
        </header>

        <div class="card" style="background-color: var(--color-primary); color: white; padding: 15px; text-align: center;">
            <p style="font-size: 0.9rem;">Saldo Anda Saat Ini</p>
            <h1 id="current-balance" style="margin: 5px 0; font-size: 2rem;">Rp 0</h1>
        </div>

        <section class="card" style="margin-top: 20px;">
            <h3>Form Pengajuan Withdraw</h3>
            <form id="withdraw-form">
                
                <label for="amount" style="display: block; margin-top: 10px;">Jumlah Penarikan (IDR):</label>
                <input type="number" id="amount" placeholder="Contoh: 50000" min="25000" required>
                <p style="font-size: 0.8em; color: #64748B; margin-top: -10px; margin-bottom: 15px;">Minimal penarikan adalah Rp 10.000.</p>

                <label for="method" style="display: block;">Metode Penarikan:</label>
                <select id="method" required style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #E2E8F0;">
                    <option value="">-- Pilih Metode --</option>
                    <option value="Dana">DANA</option>
                    <option value="OVO">OVO</option>
                    <option value="Gopay">GOPAY</option>
                    <option value="Bank">Transfer Bank</option>
                </select>

                <label for="account-number" style="display: block;">Nomor Akun/Rekening:</label>
                <input type="text" id="account-number" placeholder="Contoh: 081234567890 atau No. Rekening" required>
                
                <button type="submit" class="btn-primary" id="withdraw-button">
                    Ajukan Penarikan
                </button>
                <p id="withdraw-status" style="margin-top: 10px; text-align: center; color: red;"></p>
            </form>
        </section>

        <section class="card" style="margin-top: 20px;">
            <h3>Riwayat Withdraw Pending</h3>
            <div id="pending-withdraw-status">
                <p style="color: #64748B;">Memuat permintaan penarikan...</p>
            </div>
        </section>
        
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i><p>Home</p>
        </a>
        <a href="tasks.html" class="nav-item">
            <i class="fas fa-clipboard-list"></i><p>Tugas</p>
        </a>
        <a href="withdraw.html" class="nav-item active">
            <i class="fas fa-money-bill-wave"></i><p>Tarik</p>
        </a>
        <a href="history.html" class="nav-item">
            <i class="fas fa-history"></i><p>Riwayat</p>
        </a>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    
    <script>
        const currentBalanceElement = document.getElementById('current-balance');
        const withdrawForm = document.getElementById('withdraw-form');
        const amountInput = document.getElementById('amount');
        const methodSelect = document.getElementById('method');
        const accountNumberInput = document.getElementById('account-number');
        const withdrawButton = document.getElementById('withdraw-button');
        const withdrawStatusElement = document.getElementById('withdraw-status');
        const pendingWithdrawContainer = document.getElementById('pending-withdraw-status');

        let currentUid = null;
        let userCurrentBalance = 0;
        const MIN_WITHDRAWAL = 25000;

        // --- Guard Auth & Data Realtime ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUid = user.uid;
            
            // Ambil saldo realtime
            db.collection("users").doc(currentUid).onSnapshot(doc => {
                if (doc.exists) {
                    userCurrentBalance = doc.data().balance;
                    // Format saldo
                    currentBalanceElement.textContent = new Intl.NumberFormat('id-ID', { 
                        style: 'currency', 
                        currency: 'IDR', 
                        minimumFractionDigits: 0 
                    }).format(userCurrentBalance);
                }
            });

            loadPendingWithdrawals(currentUid);
        });

        // --- Handle Form Submission ---
        withdrawForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            withdrawStatusElement.textContent = '';
            
            const amount = parseInt(amountInput.value);
            const method = methodSelect.value;
            const number = accountNumberInput.value.trim();

            if (amount < MIN_WITHDRAWAL) {
                withdrawStatusElement.textContent = `Minimal penarikan adalah Rp ${MIN_WITHDRAWAL.toLocaleString('id-ID')}.`;
                return;
            }
            if (amount > userCurrentBalance) {
                withdrawStatusElement.textContent = 'Saldo Anda tidak mencukupi.';
                return;
            }

            withdrawButton.disabled = true;
            withdrawButton.textContent = 'Mengajukan...';

            try {
                // Gunakan Transaction untuk memastikan konsistensi pengurangan saldo dan penambahan withdraw
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection("users").doc(currentUid);
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists) {
                        throw new Error("Data pengguna tidak ditemukan.");
                    }

                    const currentBalance = userDoc.data().balance || 0;
                    if (currentBalance < amount) {
                        throw new Error("Saldo tidak mencukupi saat transaksi.");
                    }

                    // 1. Tambahkan permintaan withdraw
                    await db.collection("withdraws").add({
                        uid: currentUid,
                        amount: amount,
                        method: method,
                        number: number,
                        status: "pending",
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 2. Kurangi saldo user 
                    transaction.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(-amount)
                    });
                    
                    // 3. Tambahkan riwayat transaksi (Debit)
                    await db.collection("history").add({
                        uid: currentUid,
                        type: "withdraw_request",
                        amount: -amount,
                        description: `Pengajuan Withdraw ke ${method} sebesar Rp ${amount.toLocaleString('id-ID')}`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });


                withdrawStatusElement.style.color = 'var(--color-primary)';
                withdrawStatusElement.textContent = `Pengajuan penarikan Rp ${amount.toLocaleString('id-ID')} berhasil diajukan! Menunggu diproses Admin.`;
                withdrawForm.reset(); // Reset form setelah sukses

            } catch (error) {
                console.error("Withdrawal Error:", error);
                withdrawStatusElement.style.color = 'red';
                withdrawStatusElement.textContent = `Gagal mengajukan penarikan: ${error.message}.`;
            } finally {
                withdrawButton.disabled = false;
                withdrawButton.textContent = 'Ajukan Penarikan';
            }
        });

        // --- Load Status Withdraw User yang Pending ---
        function loadPendingWithdrawals(uid) {
            // Membutuhkan Index: withdraws -> uid (Asc), status (Asc), requestedAt (Desc)
            db.collection("withdraws")
              .where("uid", "==", uid)
              .where("status", "==", "pending")
              .orderBy("requestedAt", "desc")
              .onSnapshot(snapshot => {
                pendingWithdrawContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingWithdrawContainer.innerHTML = '<p>Saat ini tidak ada permintaan penarikan yang menunggu diproses.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const wd = doc.data();
                    const amountFormatted = wd.amount.toLocaleString('id-ID');
                    
                    pendingWithdrawContainer.innerHTML += `
                        <div style="padding: 10px 0; border-bottom: 1px solid #E2E8F0;">
                            <div style="display: flex; justify-content: space-between; font-weight: 600;">
                                <span>Withdraw Rp ${amountFormatted}</span>
                                <span style="color: orange;">PENDING</span>
                            </div>
                            <p style="font-size: 0.9em; color: #64748B;">Ke: ${wd.method} (${wd.number})</p>
                            <p style="font-size: 0.8em; color: #94A3B8;">Diajukan: ${wd.requestedAt ? new Date(wd.requestedAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    `;
                });
              }, error => {
                console.error("Error loading pending withdrawals:", error);
                pendingWithdrawContainer.innerHTML = '<p style="color: red;">Gagal memuat permintaan withdraw. Cek konsol!</p>';
              });
        }
    </script>
</body>

</html>

